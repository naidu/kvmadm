# Purpose #

The **kvmadm** project is aimed to provide a minimalistic set of tools to facilitate and control multi-user usage of [Kernel Virtual Machine](http://kvm.qumranet.com). The KVM uses QEMU code as frontend. Certain actions needed to start a KVM virtual machine require root privileges. This package provides a secure setuid wrapper which performs necessary actions in controlled manner, and then drops privileges to the user level. Instances of KVM themselves run under privileges of users rather than those of root.

# Hardware Requirements #

Requirements to the CPU type are the same as specified for KVM itself. The host computer must have a virtualization-capable CPU (Intel or AMD).

# Software Requirements #

## KVM Version ##

The current version of the **kvmadm** package is labeled as 0-17 as it has been tested with the KVM release labeled 17. However any other version of KVM compatible in QEMU command line options may be used.

## Other Utilities ##

Two external utilities **kvmadm** uses are `ifconfig` and `brctl`. KVM requires the same utilities to be installed on the host computer.

# Installation #

## System-Wide Settings ##

In order to run KVM under user privileges, users must have write permissions on the `/dev/kvm` device. To provide this, it is recommended to do the following:

  * Create a group named for example `vm`. All users who are allowed to start instances of KVM must be members of this group.
  * Create udev rules as to make `/dev/kvm` writable by the members of the `vm` group by inserting the following lines in one of udev rule files:

```
# automatically assign root.vm ownership to /dev/kvm

KERNEL=="kvm",           MODE="0660", GROUP="vm"
```

The VM toplevel directory must be created as `/usr/share/KVM`. It should be owned by root.root and allow only read access for non-root users.

Bridge(s) for connecting virtual machines to each other, and to the outside networks, must be created and configured.

## Compilation from Sources ##

**Kvmadm** _should_ be compiled from sources. No pre-built binary distribution is provided.

1. Unpack the distribution tarball. Change to the toplevel distribution directory (`kvmadm- 0-17`).

2. Make sure that the following executables are on the default PATH prior to compilation:
  * ifconfig
  * brctl
  * qemu-system-x86\_64
If some of these executables are not on the default PATH, modify PATH like shown below:
```
PATH=custom:path:extensions:$PATH ./configure
```
Otherwise just run `./configure`.

3. In the distribution toplevel directory, run `make`

4. Installation of the binaries and scripts _should_ be performed under the root privileges:

```
su -c "make install"
```

The following files will be installed (in `/usr/sbin` by default):

  * `kvmrun` - the secure wrapper (binary), installed with setuid bit on
  * `kvmparms` - a helper script to process the contents of a VM subdirectory; not to be ran on its own
  * `kvmid` - a helper script to generate a VM identifier based on bridge name and KVM system options

Absolute paths to `ifconfig`, `brctl`, and `qemu-system-x86_64` executables will be captured during the configure phase and hardcoded into the `kvmrun` binary executable.

# Virtual Machines Infrastructure #

**Kvmadm** does not have configuration files. The whole virtual machines infrastructure is defined by appropriate file system entries (i. e. files, symbolic links, and directories).

Each virtual machine is represented by a subdirectory in the VM toplevel directory. Name of a VM subdirectory contains the following:

  * name of the bridge interface where VM's NIC will be connected to via a tap device;
  * MAC address to assign to the VM's NIC;
  * QEMU system options encoded in base64 to avoid special characters in the subdirector y name.

An example of such VM subdirectory name is below:

```
br0.FE:43:56:4A:6F:51.Ii1tIiAiMTk2IiAiLW5vLXJ0YyIgIi1sb2NhbHRpbWUiIA==
```

(generated by `kvmid` for QEMU system options `-m 196 -no-rtc -localtime`

However users do not need to remember or type such long directory names. From the users standpoint, virtual machines are identified by short names that belong to symbolic links to VM subdirectories.

```
lrwxrwxrwx 1 root root     71 2007-07-09 21:17 ArchDuke -> br0.FE:B9:29:12:42:19.Ii1tIiAiMTk2IiAiLW5vLXJ0YyIgIi1sb2NhbHRpbWUiIA==/
drwx------ 2 dima users  4096 2007-07-09 23:45 br0.FE:B9:29:12:42:19.Ii1tIiAiMTk2IiAiLW5vLXJ0YyIgIi1sb2NhbHRpbWUiIA==
```

The example above shows a virtual machine named `ArchDuke` whose NIC will be connected to the bridge named `br0`, will be assigned MAC address `FE:B9:29:12:42:19`, and QEMU will be passed options `-m 196 -no-rtc -localtime` in addition to user-defined options.

Name of virtual machine will be used to name the tap device used to connect the VM to the bridge. The tap device will be named `tap-ArchDuke` for the example given. Therefore, length of VM name is limited: it should not exceed the value of `IFNAMSIZ - 5` where `IFNAMSIZ` is defined in the file `/usr/include/linux/if.h` as 16 (so, VM name should not be longer than 11 characters).

Such naming of tap devices also prevents users from uncontrolled running multiple instances of virtual machines: more than one tap device with same name cannot be created.

Each VM subdirectory contains files and symbolic links that define options controlled by users to be passed to QEMU to launch a virtual machine.

# Options that Users Control #

For security reasons, users are restricted in QEMU options that they can pass to launch virtual machines. These options are given below along with entries in VM subdirectory that control them.

## Block Devices ##

  * fda - floppy disk 0 image. Appearance of this file adds the `-fda fda` option to QEMU command line

  * fdb - floppy disk 1 image. Appearance of this file adds the `-fdb fdb` option to QEMU command line

  * hda - hard disk image. Appearance of this file adds the `-hda hda` option  to QEMU command line

  * hdb - hard disk image. Appearance of this file adds the `-hdb hdb` option  to QEMU command line

  * cdrom - CD ROM image. Appearance of this file adds the `-cdrom cdrom` option  to QEMU command line

## Externally Loaded Linux Kernel ##

  * kernel - Linux kernel to load. Appearance of this file adds the `-kernel kernel` option to QEMU command line if boot mode is set to external Linux kernel (see below)

  * append - file containing Linux kernel command line. Appearance of this file adds the `-append "xxxx"` option to QEMU command line where "xxxx" is contents of the `append` file if boot mode is set to external Linux kernel (see below)

  * initrd - image of Linux kernel initialization RAM disk. Appearance of this file adds the `- inirtdr initrd` option to QEMU command line if boot mode is set to external Linux kernel (see below)

## Boot Mode ##

  * boot - symbolic link that points to one of `fda`, `hda`, `cdrom`, `kernel`. It controls the `-boot` QEMU command line option which will be `a`, `c`, `d` in the first three cases, and in the fourth case `-boot`  will not be used, but `-kernel` will be used instead, as described above. If boot contains anything else, `-boot n` will be provided (network boot)

## Interface Control ##

  * nographic - file whose contents does not matter (may be of zero length). Its appearance adds the `-nographic` option to QEMU command line suppressing the console window

  * serial - file containing the character device name to redirect the emulated serial device (`/dev/ttyS0` for Linux). If the file contains `stdio`, serial device will be redirected to the terminal from which the VM is launched

## Other Options ##

  * no-acpi, no-reboot - files whose contents starts with either 'y' or 'n' (may be upper or lower case). Appearance of these files  adds `-no-acpi` and `-no-reboot` QEMU command line options with values depending on the first characters of those files

  * rom - file containing a ROM image. Its appearance adds the `-option-rom rom` option to QEMU command line

The following VM subdirectory entries may be either files or symbolic links: fda, hda, hdb, cdrom, kernel, initrd, rom. The following entries should be files: no-acpi, no-reboot, append, serial, nographic. the following entry should be a symbolic  link: boot.

# Usage Scenarios #

## Administrative Tasks (Performed under Root Privileges) ##

### Creation of a New Virtual Machine ###

  * Change to the VM toplevel directory:

```
cd /usr/share/KVM
```

  * Identify name of the bridge interface the VM will be used with (e. g. br0). Define memory amount to allocate to the virtual machine. Define other options (e. g. -no-rtc, -localtime to use host computer's clock). Create a VM subdirectory (dot as the second argument to `kvmid` causes random MAC address for VM's NIC to be generated, otherwise specify the desired MAC address):

```
mkdir `/usr/sbin/kvmid br0 . -m 196 -no-rtc -localtime`
```

  * Assign proper ownership and permissions to the VM subdirectory (the first line of `ls` output sorted by creation time descending, in one column  - it is "1", not lowercase "ell"   in "-1tc"), is the name of VM subdirectory just created):

```
chown joe.users `ls -1tc | head -n 1`
chmod 0700 `ls -1tc | head -n 1`
```

  * Create a symbolic link for the VM subdirectory which contains the user-visible name of the virtual machine:

```
ln -sf `ls -1tc | head -n 1` NewVM
```

### Archiving and Cloning Virtual Machines ###

Virtual machine may be cloned by archiving and unarchiving of its subdirectory containing disk images, kernel, etc. It is important to use `tar cvpzf` command to archive, and `tar xzpvf` command to unarchive to preserve symbolic links and file attributes properly.

## User Tasks ##

### Installation from a CD ROM Image ###

  * Change to the VM subdirectory:

```
cd /usr/share/KVM/NewVM
```

  * Locate the CD ROM image to install from. Copy or symlink the image to the VM subdirectory:

```
cp /path/to/cd/rom/image cdrom
# or
ln -sf /path/to/cd/rom/image cdrom
```

  * Create the empty hda disk image (5 Gigabytes for example):

```
/path/to/qemu-img create -f qcow hda 5G 
```

  * Specify boot mode from the CD ROM image:

```
ln -sf cdrom boot
```

  * Boot the VM from CD ROM and install the operating system on hda:

```
/usr/sbin/kvmrun NewVM
```

  * After the installation is complete, halt the VM, and remove the link to CD ROM image (unless it is needed for any purpose). Specify boot mode from the disk image:

```
rm cdrom
ln -sf hda boot
/usr/sbin/kvmrun NewVM
```

  * In this mode, graphic console window will appear, and all interaction with the virtual machine will be possible through this window.

### Redirecting VM Linux Console to Users Terminal ###

In this scenario, we assume that some flavor of Linux is installed onto the virtual machine. We also assume that the Linux kernel that was built during the installation process was somehow extracted (along with the init RAM disk image) from the hda disk image.

  * Change to the VM subdirectory:

```
cd /usr/share/KVM/NewVM
```

  * Locate the Linux kernel and init RAM disk files and copy or symlink them into the VM subdirectory under appropriate names:

```
ln -sf /path/to/linux/kernel kernel
ln -sf /path/to/init/ramdisk initrd
```

  * Specify the boot mode from the external Linux kernel. Make sure that VM is still bootable (with the graphic console window). Setting the root disk device may be necessary; create the `append` file for this purpose:

```
ln -sf kernel boot
echo -n "root=/dev/sda3" > append
/usr/sbin/kvmrun NewVM
```

  * Log on as root into the virtual machine using the console window. Modify the /etc/inittab file to run `agetty` on the serial console (we assume that "xterm" is user's terminal type, but this may be anything else, e. g. rxvt ot linux):

```
cc:2345:respawn:/sbin/agetty 9600 ttyS0 xterm
c1:2345:respawn:/sbin/agetty 38400 vc/1 linux
c2:2345:respawn:/sbin/agetty 38400 vc/2 linux
c3:2345:respawn:/sbin/agetty 38400 vc/3 linux
c4:2345:respawn:/sbin/agetty 38400 vc/4 linux
c5:2345:respawn:/sbin/agetty 38400 vc/5 linux
c6:2345:respawn:/sbin/agetty 38400 vc/6 linux
```

  * Modify the /etc/securetty file to allow root login from the serial line:

```
ttyS0
console
vc/1
vc/2
vc/3
vc/4
vc/5
```

  * Halt the virtual machine. Specify redirection of the serial device to the users terminal, and instruct the Linux kernel to use serial line as console:

```
echo -n " console=ttyS0,9600" >> append
echo -n "stdio" > serial
echo > nographic
/usr/sbin/kvmrun NewVM
```

Kernel boot messages will appear on users terminal. When the boot sequence is completed, login prompt will show up.

### Passing Arbitrary Information to VM ###

Sometimes it may be necessary to pass some ad-hoc information (not contained on VM's disk images, but determined right before the VM launch time) to a virtual machine being launched. Putting/changing files on VM's disk images is not feasible because they may be in the qcow format (not usable with loopback mount, not to mention that loopback usage is a privileged operation), or be formatted with a file system that the host computer does not recognize. Additionally, such deliberate modification of VM's images is dangerous of unintended file system corruption on disk images.

Floppy disks however have few or no use for virtual machines, unless some floppy-based installation is performed. Anyway it is safe to assume that the Floppy 1 (`/dev/fd1` on the guest VM) is not used at all.

Users may take advantage of this fact, and create the `fdb` file in the VM subdirectory, which contains the necessary information (and amount of such is only limited to the floppy disk image, usually 1.44M). This does not need to be an image of (V)FAT filesystem; any format is acceptable, but size of the `fdb` file should not be less that one sector (512 bytes) and should be multiple of 512.

For example, user may pack some files from their home directory in a `cpio` archive and name the archive `fdb`. A practical example is the `.Xauthority` file containing authentication cookies necessary to run X Window applications on the virtual machine.

So, prior to launching a virtual machine, user may execute this command:

```
(cd $HOME ; ls .Xauthority | cpio -o -C 512) >/usr/share/KVM/NewVM/fdb
```

The VM boot script should copy the `cpio` archive from `/dev/fd1` to the user's home directory on VM (so, name of the user must somehow be known to the VM, but it may be safely passed as one of kernel boot parameters, or otherwise within the same `cpio` archive via the floppy disk image). Further, user login script will extrac the `.Xauthority` file from the archive. It is assumed that the `.Xauthority` file contains X display host name that VM may use.

### Automatic Start of X11 Applications in Virtual Machine ###

One of possibilities kvmadm provides is to create "private" virtual machines that authorized user may start and use alone. Therefore the user who launches the virtual machine receives special treatment. Once the virtual machine boots, user's X11 session starts automatically (that is, a window manager, or a terminal emulator, or any other application starts without requirement for the user to log into the virtual machine started.

In order to enable automatic start of user X11 applications in the virtual machine, the following needs to be done:

  * The `autouser` script located in the `vmscripts` subdirectory of the source distribution should be copied onto the virtual machine's disk image and run at the very end of the VM boot process. This script accepts a parameter which should be "start" in order to automatically start user's applications. Suggested location for the script is `/etc/rc.d`, and the way to execute it depends on the VM operating system's boot scripts structure.

  * User account with the same name as the user launching the virtual machine is known to the host, should be created on the virtual machine. Password does not need to be the same as on the host: indeed, it is not asked when starting user's X11 applications.

  * The `userfiles` plain text file should be created in the VM subdirectory. The file may be empty, or contain a list of file paths relative to the user's home directory on the host computer, one path per line. This file is not modified by kvmadm scripts.

  * The `.VMUSERINFO` file should be created in the user's home directory on the host computer. This file will be overwritten by kvmadm scripts each time the virtual machine is launched.

  * Automatic start of user's X11 applications uses the `fdb` virtual floppy image in the VM subdirectory. Any existing `fdb` file will be overwritten by kvmadm scripts each time the virtual machine is launched.

When a virtual machine is started (user types `/usr/sbin/kvmrun VMName` on the host computer), presence and contents of the two files is analyzed: `.VMUSERINFO` in user's home directory, and `userfiles` in the VM subdirectory.

If the former file is present, it is filled with the following information:

  * name of the user who launches the VM (result of `set | grep USER`)
  * name and screen number of the X11 display which will be used by user's X11 applications on the VM (result of `set | grep DISPLAY`)
  * X server authentication information (result of `xauth nlist $DISPLAY`)

If the latter file is present, all file paths it contains are tested for existence and being regular files (not directories). Non-esixting or non-accessible files are ignored.

The name of the `.VMUSERINFO` file along with names contained in the `userfiles` file is fed to the standard input of the `cpio` utility which creates an archive. This archive is placed in the VM subdirectory as the `fdb` floppy disk image.

When the VM boots, at some point the `autouser` script is executed. The script checks presence of the floppy 1 (`/dev/fd1`), and if present, tries to read the `.VMUSERINFO` file from the emulated floppy into the `/tmp` directory. If successful, user name is extracted from the file. User's home directory is checked for existence. If it exists, the whole cpio archive is copied there and all files extracted.

Next, at the user's privileges, the login profile is executed, the `DISPLAY` variable is set accordingly in the user's environment, and X server authentication cookie is created.

Finally, if the user's home directory on the virtual machine contains the `.vmsession` file, it is executed as a shell script. Otherwise the `xterm` program is started.

The `.vmsession` file may be copied from the host to the VM if its name is included in the `userfiles` file, but this does not happen automatically.

X window manager may run on either the host, or on VM; kvmadm does not enforce this. However if a `wm` file is present in the VM subdirectory (content does not matter, may be even empty), and the special patched version of evilwm (see EvilvmPatch) is running on the host computer, kvmadm will suspend evilwm right before launching the VM (thus making it possible to run a window manager on VM) and restart evilwm as soon as the KVM (qemu-system) executable terminates.

# Sample Configuration #